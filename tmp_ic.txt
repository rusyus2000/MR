                .Include(it => it.ExecutiveSponsor)
                .Include(it => it.StatusLookup)
                .Include(it => it.OperatingEntityLookup)
                .Include(it => it.RefreshFrequencyLookup)
                .Include(it => it.ItemDataConsumers)
                    .ThenInclude(dc => dc.DataConsumer)
                .FirstOrDefaultAsync(it => it.Id == id);
            if (i == null) return NotFound();
            // Non-admins cannot view non-Published items
            var user = CurrentUser;
            var isAdmin = user?.UserType == "Admin";
            if (!isAdmin)
            {
                var published = await _db.LookupValues.FirstOrDefaultAsync(l => l.Type == "Status" && l.Value == "Published");
                if (published != null && i.StatusId.HasValue && i.StatusId.Value != published.Id)
                {
                    return NotFound();
                }
            }
            // record that the current user opened this asset
            try
            {
                var u = CurrentUser;
                if (u != null)
                {
                    _db.UserAssetOpenHistories.Add(new UserAssetOpenHistory
                    {
                        UserId = u.Id,
                        ItemId = i.Id,
                        OpenedAt = DateTime.UtcNow
                    });
                    await _db.SaveChangesAsync();
                }
            }
            catch
            {
                // Ignore logging errors
            }

            return Ok(new ItemDto
            {
                Id = i.Id,
                Title = i.Title,
                Description = i.Description,
                Url = i.Url,
                Tags = i.ItemTags.Select(it => it.Tag.Value).ToList(),
                AssetTypeId = i.AssetTypeId,
                AssetTypeName = i.AssetType != null ? i.AssetType.Value : null,
                DomainId = i.DomainId,
                DivisionId = i.DivisionId,
                ServiceLineId = i.ServiceLineId,
                DataSourceId = i.DataSourceId,
                Domain = i.DomainLookup != null ? i.DomainLookup.Value : null,
                Division = i.DivisionLookup != null ? i.DivisionLookup.Value : null,
                ServiceLine = i.ServiceLineLookup != null ? i.ServiceLineLookup.Value : null,
                DataSource = i.DataSourceLookup != null ? i.DataSourceLookup.Value : null,
                StatusId = i.StatusId,
                Status = i.StatusLookup != null ? i.StatusLookup.Value : null,
                OwnerId = i.OwnerId,
                OwnerName = i.Owner != null ? i.Owner.Name : null,
                OwnerEmail = i.Owner != null ? i.Owner.Email : null,
                ExecutiveSponsorId = i.ExecutiveSponsorId,
                ExecutiveSponsorName = i.ExecutiveSponsor != null ? i.ExecutiveSponsor.Name : null,
                ExecutiveSponsorEmail = i.ExecutiveSponsor != null ? i.ExecutiveSponsor.Email : null,
                OperatingEntityId = i.OperatingEntityId,
                OperatingEntity = i.OperatingEntityLookup != null ? i.OperatingEntityLookup.Value : null,
                RefreshFrequencyId = i.RefreshFrequencyId,
                RefreshFrequency = i.RefreshFrequencyLookup != null ? i.RefreshFrequencyLookup.Value : null,
                DataConsumers = i.ItemDataConsumers.Select(dc => dc.DataConsumer.Value).ToList(),
                PrivacyPhi = i.PrivacyPhi,
                PrivacyPii = i.PrivacyPii,
                HasRls = i.HasRls,
                Dependencies = i.Dependencies,
                DefaultAdGroupNames = i.DefaultAdGroupNames,
                LastModifiedDate = i.LastModifiedDate,
                DateAdded = i.DateAdded,
                Featured = i.Featured
            });
        }

        public class ExportRequest { public List<int> Ids { get; set; } = new(); }

        // Admin-only export of items as CSV (values, not IDs)
        [HttpPost("export")]
        public async Task<IActionResult> Export()
        {
            var user = CurrentUser;
            if (user?.UserType != "Admin") return Forbid();
            List<int>? idsToExport = null;

            // Try FormData ids first (avoids preflight)
            if (Request.HasFormContentType)
            {
                var form = await Request.ReadFormAsync();
                var ids = new List<int>();
                foreach (var v in form["ids"]) { if (int.TryParse(v, out var id)) ids.Add(id); }
                if (ids.Count > 0) idsToExport = ids;
            }
            else if (Request.ContentLength.GetValueOrDefault() > 0 &&
                     (Request.ContentType?.Contains("application/json", StringComparison.OrdinalIgnoreCase) ?? false))
            {
                try
                {
                    using var sr = new StreamReader(Request.Body, Encoding.UTF8, leaveOpen: true);
                    var json = await sr.ReadToEndAsync();
                    if (!string.IsNullOrWhiteSpace(json))
                    {
                        var dto = JsonSerializer.Deserialize<ExportRequest>(json);
                        if (dto?.Ids != null && dto.Ids.Count > 0) idsToExport = dto.Ids;
                    }
                }
                catch { }
            }
            // If no IDs provided in any format, export ALL items

            var query = _db.Items.AsNoTracking();
            if (idsToExport != null)
            {
                query = query.Where(i => idsToExport.Contains(i.Id));
            }
